const SPREADSHEET_ID = "1oz7w1Zn8n5Z5s1RoEucuKuFEBiRKQ7cPmz9WcjnRGHA";
const DRIVE_FOLDER_ID = "1To9B5f_6WH4pynezKSTtTqVwqA_Zdb5Q";

const SHEETS_CONFIG = {
  MIEMBRO_1: { fuente: 'planespro', nombreHoja: 'PlanesPro' },
  MIEMBRO_2: { fuente: 'mpasesores', nombreHoja: 'MP Asesores' },
  DEFAULT_SHEET: 'PlanesPro'
};

// --- ESTRUCTURA DE COLUMNAS ACTUALIZADA ---
const COLUMN_HEADERS = [
  'FechaEnvio','Estado','CTA','Campa√±a','Nombre','Rut','Email','Tel√©fono','Edad','Factor',
  'Est. Civil','Comuna','Regi√≥n','Sist. Salud','Isapre','Anualidad','Estatura','Peso',
  'Cargas','Edad Cargas','Inter√©s','Costo Plan','Evaluar AFP','AFP','Archivo PDF',
  'Contacto WA','Estado WA'
];

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('Acciones de Contacto')
    .addItem('Preparar Mensaje de WhatsApp', 'prepararContactoWhatsApp')
    .addToUi();
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);

  try {
    const data = {};
    for (const k in e.parameter) data[k] = e.parameter[k];
    Logger.log("üì• Par√°metros recibidos: " + JSON.stringify(data));

    const fuente = (data.fuente_cta || '').toLowerCase();
    const target = fuente === SHEETS_CONFIG.MIEMBRO_1.fuente
      ? SHEETS_CONFIG.MIEMBRO_1.nombreHoja
      : fuente === SHEETS_CONFIG.MIEMBRO_2.fuente
      ? SHEETS_CONFIG.MIEMBRO_2.nombreHoja
      : SHEETS_CONFIG.DEFAULT_SHEET;

    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(target);
    if (!sheet) throw `Hoja "${target}" no encontrada.`;
    if (sheet.getLastRow() === 0) sheet.appendRow(COLUMN_HEADERS);

    let pdfUrl = '';
    try {
      if (e.parameter.base64pdf) {
        const base64 = e.parameter.base64pdf;
        
        // --- NOMBRE DE PDF MEJORADO CON FECHA PARA ORDENAR ---
        const fechaActual = new Date();
        const fechaFormateada = Utilities.formatDate(fechaActual, "America/Santiago", "yyyy-MM-dd_HHmm");
        const nombreCliente = (data.nombre || 'SinNombre').replace(/\s+/g, '_');
        const rutCliente = data.rut || 'SinRUT';
        const nombreArchivo = `${fechaFormateada}_${nombreCliente}_${rutCliente}.pdf`;
        
        const decoded = Utilities.base64Decode(base64);
        const blob = Utilities.newBlob(decoded, MimeType.PDF, nombreArchivo);
        const file = DriveApp.getFolderById(DRIVE_FOLDER_ID).createFile(blob);
        const fileId = file.getId();
        pdfUrl = `=HYPERLINK("https://drive.google.com/file/d/${fileId}/view", "${nombreArchivo}")`;
        Logger.log("‚úÖ PDF subido con √©xito: " + fileId);
      }
    } catch (err) {
      Logger.log("‚ùå Error al procesar archivo base64: " + err);
    }

    const row = COLUMN_HEADERS.map(h => {
      switch (h) {
        case 'FechaEnvio': return new Date();
        case 'Estado': return data.status || 'Completado';
        case 'CTA': return data.fuente_cta || '';
        case 'Campa√±a': return data.campana || '';
        case 'Nombre': return data.nombre || '';
        case 'Rut': return data.rut || '';
        case 'Email': return data.email || '';
        case 'Tel√©fono': return data.telefono || '';
        case 'Edad': return data.rango_edad || '';
        case 'Factor': return data.factor || '';
        case 'Est. Civil': return data.estado_civil || '';
        case 'Comuna': return data.comuna || '';
        case 'Regi√≥n': return data.region || '';
        case 'Sist. Salud': return data.sistema_actual || '';
        case 'Isapre': return data.isapre_especifica || '';
        case 'Anualidad': return data.anualidad_isapre || '';
        case 'Estatura': return data.estatura || '';
        case 'Peso': return data.peso || '';
        case 'Cargas': return data.num_cargas || '';
        case 'Edad Cargas': return data.edad_cargas || '';
        case 'Inter√©s': return data.interes || '';
        case 'Costo Plan': return data.rango_costo || '';
        case 'Evaluar AFP': return data.evaluar_afp || '';
        case 'AFP': return data.afp_actual || '';
        case 'Archivo PDF': return pdfUrl || '';
        case 'Contacto WA': return '';
        case 'Estado WA': return '';
        default: return '';
      }
    });

    sheet.appendRow(row);

    const lastRow = sheet.getLastRow();
    const telefono = data.telefono || '';
    const nombre = data.nombre || '';
    const comuna = data.comuna || '';
    const region = data.region || '';
    const sistema = data.sistema_actual || '';
    const isapre = sistema === 'Isapre' ? ` (${data.isapre_especifica || ''})` : '';
    const cargas = data.num_cargas > 0 ? `‚Ä¢ Cargas: ${data.num_cargas}\n` : '';
    const interes = data.interes || '';
    const costo = data.rango_costo || '';
    const afp = data.evaluar_afp === 'Si' ? `‚Ä¢ Me interesa AFP\n‚Ä¢ AFP Actual: ${data.afp_actual || ''}\n` : '';
    const msg = `Hola, ${nombre}, te saludamos de PlanesPro:\n\n` +
      `‚Ä¢ Rut: ${data.rut || ''}\n` +
      `‚Ä¢ Tel√©fono: ${telefono}\n` +
      `‚Ä¢ Comuna: ${comuna}\n` +
      `‚Ä¢ Regi√≥n: ${region}\n` +
      `‚Ä¢ Sistema de Salud: ${sistema}${isapre}\n` +
      cargas +
      `‚Ä¢ Inter√©s: ${interes}\n` +
      `‚Ä¢ Costo plan actual: ${costo}\n` +
      afp +
      `\nGracias por tu confianza.\nPronto te entregamos tu an√°lisis.`;
    const url = `https://wa.me/56${telefono.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;

    sheet.getRange(lastRow, COLUMN_HEADERS.indexOf('Contacto WA') + 1).setFormula(`=HYPERLINK("${url}"; "Enviar WhatsApp")`);
    
    if (data.status !== 'Abandonado' && data.email) {
      sendConfirmationEmail(data);
    }

    return ContentService.createTextOutput(JSON.stringify({ result: 'success', message: 'Formulario enviado con √©xito.' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("‚ùå Error en doPost: " + err);
    return ContentService.createTextOutput(JSON.stringify({ result: 'error', message: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function prepararContactoWhatsApp() {
  const ui = SpreadsheetApp.getUi();
  const sh = SpreadsheetApp.getActiveSheet();
  const sel = sh.getActiveRange();
  if (sel.getNumRows() > 1 || sel.getRow() < 2) {
    ui.alert('Selecciona UNA fila v√°lida.');
    return;
  }

  const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];
  const row = sh.getRange(sel.getRow(), 1, 1, sh.getLastColumn()).getValues()[0];
  const d = Object.fromEntries(headers.map((h, i) => [h, row[i]]));

  if (d['Estado WA'] === 'Contactado') {
    ui.alert('Ya fue contactado.');
    return;
  }

  const cargasTxt = d['Cargas'] > 0 ? `‚Ä¢ Cargas: ${d['Cargas']}\n` : '';
  const isapreTxt = d['Sist. Salud'] === 'Isapre' && d['Isapre'] ? ` (${d['Isapre']})` : '';
  const afpTxt = d['Evaluar AFP'] === 'Si' ? `‚Ä¢ Me interesa AFP\n‚Ä¢ AFP Actual: ${d['AFP']}\n` : '';

  const msg = `Hola, ${d['Nombre']}, te saludamos de PlanesPro:\n\n` +
    `‚Ä¢ Rut: ${d['Rut']}\n` +
    `‚Ä¢ Tel√©fono: ${d['Tel√©fono']}\n` +
    `‚Ä¢ Comuna: ${d['Comuna']}\n` +
    `‚Ä¢ Regi√≥n: ${d['Regi√≥n']}\n` +
    `‚Ä¢ Sistema de Salud: ${d['Sist. Salud']}${isapreTxt}\n` +
    cargasTxt +
    `‚Ä¢ Inter√©s: ${d['Inter√©s']}\n` +
    `‚Ä¢ Costo plan actual: ${d['Costo Plan']}\n` +
    afpTxt +
    `\nGracias por tu confianza.\nPronto te entregamos tu an√°lisis.`;

  const tel = `56${String(d['Tel√©fono']).replace(/\D/g, '')}`;
  const url = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
  sh.getRange(sel.getRow(), headers.indexOf('Contacto WA') + 1).setFormula(`=HYPERLINK("${url}"; "Enviar WhatsApp")`);
  sh.getRange(sel.getRow(), headers.indexOf('Estado WA') + 1).setValue('Contactado');
  ui.alert('‚úÖ Bot√≥n de WhatsApp creado y marcado como "Contactado".');
}

function sendConfirmationEmail(d) {
  if (!d.email) return;
  const cargas = d.num_cargas > 0 ? `<p><strong>Cargas:</strong> ${d.num_cargas}</p>` : '';
  const isapreTxt = d.sistema_actual === 'Isapre' && d.isapre_especifica ? ` (${d.isapre_especifica})` : '';
  const afpSection = d.evaluar_afp === 'Si'
    ? `<p><strong>Me interesa AFP</strong><br>AFP Actual: ${d.afp_actual}</p>` : '';

  const html = `
  <div style="font-family:Arial;max-width:600px;margin:auto">
    <h2 style="background:#19B471;color:white;padding:10px">PlanesPro</h2>
    <div style="padding:20px;background:#f9f9f9">
      <p>Hola <strong>${d.nombre}</strong>,</p>
      <p>Recibimos tu solicitud. Aqu√≠ tus datos:</p>
      <p><strong>RUT:</strong> ${d.rut}</p>
      <p><strong>Tel√©fono:</strong> ${d.telefono}</p>
      <p><strong>Comuna:</strong> ${d.comuna}</p>
      <p><strong>Regi√≥n:</strong> ${d.region}</p>
      <p><strong>Sistema de Salud:</strong> ${d.sistema_actual}${isapreTxt}</p>
      ${cargas}
      <p><strong>Inter√©s:</strong> ${d.interes}</p>
      <p><strong>Costo plan actual:</strong> ${d.rango_costo}</p>
      ${afpSection}
      <p>En breve recibir√°s tu evaluaci√≥n.</p>
      <p>Saludos,<br>Equipo PlanesPro</p>
    </div>
    <div style="text-align:center;font-size:12px;color:#555;padding:5px">¬© ${new Date().getFullYear()} PlanesPro</div>
  </div>`;
  MailApp.sendEmail({
    to: d.email,
    subject: "Tu an√°lisis de Plan de Salud est√° en proceso",
    htmlBody: html,
    name: "PlanesPro"
  });
}